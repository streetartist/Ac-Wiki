{% if page.meta.hide_comments is not defined or page.meta.hide_comments is not true %}
<h2 id="__comments">评论</h2>

<!-- 1. 用 preferred_color_scheme 让 giscus 自动跟随系统 -->
<script src="https://giscus.app/client.js"
        data-repo="Ac-Wiki/Ac-Wiki"
        data-repo-id="R_kgDONCnJnA"
        data-category="Announcements"
        data-category-id="DIC_kwDONCnJnM4Cjk4S"
        data-mapping="title"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="1"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="zh-CN"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>

<!-- 2. 手动切换时立即强制指定主题，无延迟 -->
<script>
/* 把 MkDocs 的调色板映射成 giscus 主题名 */
const paletteToGiscus = {
  default: 'light',
  slate  : 'dark_dimmed'
};

/* 发送主题给 giscus */
function sendGiscusTheme(theme) {
  const iframe = document.querySelector('iframe.giscus-frame');
  if (!iframe) return;
  iframe.contentWindow.postMessage(
    { giscus: { setConfig: { theme } } },
    'https://giscus.app'
  );
}

/* 在调色板切换瞬间触发，比 MutationObserver 快 */
document.addEventListener('palettechange', () => {
  const palette = document.body.dataset.mdColorScheme || 'default';
  sendGiscusTheme(paletteToGiscus[palette] || 'light');
});
</script>
{% endif %}
