{% if page.meta.hide_comments is not defined or page.meta.hide_comments is not true %}
  <!-- 预取Giscus主题CSS -->
  <link rel="prefetch" href="https://giscus.app/themes/light.css" as="style">
  <link rel="prefetch" href="https://giscus.app/themes/dark_dimmed.css" as="style">
  
  <h2 id="__comments">评论测试2</h2>
  <!-- Giscus 评论系统 -->
  <script
    src="https://giscus.app/client.js"
    data-repo="Ac-Wiki/Ac-Wiki"
    data-repo-id="R_kgDONCnJnA"
    data-category="Announcements"
    data-category-id="DIC_kwDONCnJnM4Cjk4S"
    data-mapping="title"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="1"
    data-input-position="top"
    data-theme="preferred_color_scheme"
    data-lang="zh-CN"
    data-loading="lazy"
    crossorigin="anonymous"
    async
  ></script>

  <!-- 优化后的同步脚本 -->
  <script>
    // 确保DOM加载完成
    document.addEventListener('DOMContentLoaded', function() {
      // 设置主题的函数
      function syncGiscusTheme() {
        const theme = document.body.getAttribute('data-md-color-scheme') === 'slate'
          ? 'dark_dimmed'
          : 'light';
        
        const iframe = document.querySelector('iframe.giscus-frame');
        if (iframe) {
          iframe.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            'https://giscus.app'
          );
        }
      }
      
      // 1. 使用MkDocs的原生事件监听
      document.addEventListener('md-palette', syncGiscusTheme);
      
      // 2. 添加MutationObserver作为备用
      const observer = new MutationObserver(syncGiscusTheme);
      observer.observe(document.body, {
        attributes: true,
        attributeFilter: ['data-md-color-scheme']
      });
      
      // 3. 初始加载时设置主题
      // 等待Giscus加载完成（最多等待5秒）
      const giscusInterval = setInterval(() => {
        if (document.querySelector('iframe.giscus-frame')) {
          clearInterval(giscusInterval);
          syncGiscusTheme();
        }
      }, 100);
      
      // 4. 设置超时防止无限等待
      setTimeout(() => clearInterval(giscusInterval), 5000);
    });
  </script>
{% endif %}