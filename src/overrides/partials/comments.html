{% if page.meta.hide_comments is not defined or page.meta.hide_comments is not true %}
  <!-- 
    优化方案整合：
    1. 内联 CSS：将平滑过渡的样式直接放在这里，无需额外文件。
    2. 预加载：提前获取 Giscus 的亮/暗主题 CSS，消除网络延迟。
    3. 原生事件：使用 mkdocs-material 的 JS API，实现最快的主题切换响应。
  -->

  <!-- 1. 内联 CSS，用于实现平滑的淡入淡出效果 -->
  <style>
    iframe.giscus-frame {
      /* 当不透明度变化时，应用 0.3 秒的平滑动画 */
      transition: opacity 0.3s ease-in-out;
    }
    iframe.giscus-frame.giscus-transition {
      /* 在主题切换过程中，将 iframe 透明度设为 0，实现淡出效果 */
      opacity: 0;
    }
  </style>

  <!-- 2. 预加载 Giscus 的亮色和暗色主题 CSS -->
  <link rel="prefetch" href="https://giscus.app/themes/light.css" as="style">
  <link rel="prefetch" href="https://giscus.app/themes/dark.css" as="style">

  <h2 id="__comments">评论</h2>
  
  <!-- Giscus 评论系统本体 -->
  <script
    src="https://giscus.app/client.js"
    data-repo="Ac-Wiki/Ac-Wiki"
    data-repo-id="R_kgDONCnJnA"
    data-category="Announcements"
    data-category-id="DIC_kwDONCnJnM4Cjk4S"
    data-mapping="title"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="1"
    data-input-position="top"
    data-theme="preferred_color_scheme"
    data-lang="zh-CN"
    data-loading="lazy"
    crossorigin="anonymous"
    async
  ></script>

  <!-- 3. 使用 mkdocs-material 原生事件 API 的优化版同步脚本 -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const GiscusHost = "https://giscus.app";

      // 监听 mkdocs-material 的颜色主题变化事件
      document.body._color.subscribe(function(color) {
        const iframe = document.querySelector("iframe.giscus-frame");
        if (!iframe) return; // 如果评论区 iframe 不存在，则不执行任何操作

        // a. 添加过渡类，让 iframe 平滑地淡出
        iframe.classList.add("giscus-transition");
        
        // b. 根据 mkdocs 的主题确定 Giscus 的主题
        //    我们使用 'dark'，它通常比 'dark_dimmed' 响应更快
        const giscusTheme = color.scheme === "slate" ? "dark" : "light";

        // c. 使用一个短暂的延时来确保淡出动画有时间播放，
        //    然后再发送主题切换消息并移除过渡类以实现淡入。
        setTimeout(() => {
          // 向 Giscus iframe 发送消息以更新主题
          iframe.contentWindow.postMessage(
            { giscus: { setConfig: { theme: giscusTheme } } },
            GiscusHost
          );
          // 移除过渡类，触发 CSS transition 使 iframe 平滑淡入
          iframe.classList.remove("giscus-transition");
        }, 150); // 150毫秒的延迟对于视觉过渡来说是理想的
      });
    });
  </script>
{% endif %}