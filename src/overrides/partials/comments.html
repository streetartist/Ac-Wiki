{% if page.meta.hide_comments is not defined or page.meta.hide_comments is not true %}
  <h2 id="__comments">评论</h2>
  <!-- Giscus 评论系统 -->
  <script
    src="https://giscus.app/client.js"
    data-repo="Ac-Wiki/Ac-Wiki"
    data-repo-id="R_kgDONCnJnA"
    data-category="Announcements"
    data-category-id="DIC_kwDONCnJnM4Cjk4S"
    data-mapping="title"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="1"
    data-input-position="top"
    data-theme="preferred_color_scheme"
    data-lang="zh-CN"
    data-loading="lazy"
    crossorigin="anonymous"
    async
  ></script>

  <!-- 
    优化版同步脚本：
    使用 mkdocs-material 主题的原生 JS API 监听颜色变化，
    响应速度比 MutationObserver 更快。
  -->
  <script>
    // 定义一个函数，用于向 Giscus 发送主题变更消息
    function setGiscusTheme(theme) {
      const iframe = document.querySelector('iframe.giscus-frame');
      if (iframe) {
        iframe.contentWindow.postMessage(
          { giscus: { setConfig: { theme: theme } } },
          'https://giscus.app'
        );
      }
    }

    // 确保 mkdocs-material 的 JS 对象加载完毕
    document.addEventListener("DOMContentLoaded", function() {
      // 获取 mkdocs-material 的颜色主题 observable 对象
      const colorObserver = document.body.adjective.watch("color");

      // 订阅颜色主题变化事件
      colorObserver.subscribe(function(palette) {
        // `palette.scheme` 的值是 "default" (白天) 或 "slate" (暗黑)
        const giscusTheme = palette.scheme === 'slate' 
          ? 'dark_dimmed' 
          : 'light';
        setGiscusTheme(giscusTheme);
      });

      // Giscus iframe 加载可能较慢，初始加载时也尝试设置一次主题
      // 以防用户刷新页面时主题不匹配
      setTimeout(() => {
        const initialScheme = document.body.getAttribute("data-md-color-scheme");
        const initialGiscusTheme = initialScheme === 'slate' 
          ? 'dark_dimmed' 
          : 'light';
        setGiscusTheme(initialGiscusTheme);
      }, 200); // 稍微延迟以等待 iframe 加载
    });
  </script>
{% endif %}